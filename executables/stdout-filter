#!/usr/bin/env bash
# OpenWrt Build Makefile Filter
# Version: 0.1
# Author: github.com/Ogglord

set -uo pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
GRAY='\033[0;90m'
NC='\033[0m'

# Parse command line arguments
VERBOSE=false
while [[ $# -gt 0 ]]; do
    case "$1" in
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            echo "Usage: stdout-filter [-v|--verbose] [-h|--help]"
            echo "  -v, --verbose    Show all output including INFO and WARNING messages"
            echo "  -h, --help       Show this help message"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

# Process and colorize the output in real-time from stdin
while IFS= read -r line; do
    # Simplify paths
    line=$(echo "$line" | sed "s|$(pwd)/|./|g")
    
    # Always show errors
    if [[ $line =~ ^[^\"]*[Ee]rror:.*$ ]] || [[ $line =~ ^[^\"]*ERROR:.*$ ]] || [[ $line =~ ^\[ERROR\] ]]; then
        echo -e "${RED}${line}${NC}"
        continue
    elif [[ $line =~ make\[([0-3])\].*"Entering directory" ]]; then
        echo -e "${GREEN}${line}${NC}"
        continue
    fi
    # Show other messages only in verbose mode
    if $VERBOSE; then
        
        if [[ $line =~ make\[[4-9]\].*"Entering directory" ]]; then
            echo -e "${GRAY}${line}${NC}"
        elif [[ $line =~ ^\[WARNING\] ]]; then
            echo -e "${YELLOW}${line}${NC}"
        elif [[ $line =~ ^\[INFO\] ]]; then
            echo -e "${GRAY}${line}${NC}"
        else
            echo "$line"
        fi
    fi
done
