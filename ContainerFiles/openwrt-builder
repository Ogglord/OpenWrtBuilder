ARG DEBIAN_FRONTEND="noninteractive"
ARG GO_VERSION=1.22.5
ARG ARCH=amd64
ARG UBUNTU_VERSION=24.04
ARG GIT_BRANCH

FROM quay.io/toolbx/ubuntu-toolbox:${UBUNTU_VERSION}

ENV GO_VERSION=${GO_VERSION}
ENV DEBIAN_FRONTEND=${DEBIAN_FRONTEND}
ENV ARCH=${ARCH}
ENV GIT_BRANCH=${GIT_BRANCH}

LABEL com.github.containers.toolbox="true" \
      usage="This image is meant to be used with the toolbox or distrobox command" \
      summary="This is an environment aimed at building OpenWRT images" \
      maintainer="oag@proton.me" \
      branch=${GIT_BRANCH}

# Copy files to their final destinations
COPY ../scripts/setup-env.sh /
COPY ../scripts/distrobox-shims.sh /
COPY ../packages/openwrt-builder.packages /
COPY ../executables/fetch_executables_git /fetch_executables_git.sh
COPY ../update-manifest.json /

# Set permissions and run setup
RUN chmod +x /setup-env.sh /distrobox-shims.sh /fetch_executables_git.sh && \
    GO_VERSION=${GO_VERSION} DEBIAN_FRONTEND=${DEBIAN_FRONTEND} ARCH=${ARCH} /setup-env.sh && \
    GIT_BRANCH=${GIT_BRANCH} /fetch_executables_git.sh && \
    rm /setup-env.sh /distrobox-shims.sh /fetch_executables_git.sh /openwrt-builder.packages

# Copy fish config, justfile, bass plugin as final step
COPY ../shell/config.fish /etc/fish/
COPY ../shell/bass/ /etc/fish/functions/
RUN chmod 644 /etc/fish/functions/__bass.py /etc/fish/functions/bass.fish && \
     echo "alias just='just --justfile /etc/just/justfile --unstable --working-directory .'" >> /etc/profile