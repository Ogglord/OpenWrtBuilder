ARG DEBIAN_FRONTEND="noninteractive"
ARG GO_VERSION=1.22.5
ARG UBUNTU_VERSION=24.04

FROM quay.io/toolbx/ubuntu-toolbox:${UBUNTU_VERSION}

ENV GO_VERSION=${GO_VERSION}
ENV DEBIAN_FRONTEND=${DEBIAN_FRONTEND}

LABEL com.github.containers.toolbox="true" \
      usage="This image is meant to be used with the toolbox or distrobox command" \
      summary="This is an environment aimed at building OpenWRT images" \
      maintainer="oag@proton.me"

# Copy the setup scripts and package list
COPY ../scripts/setup-env.sh /
COPY ../scripts/distrobox-shims.sh /
COPY ../packages/openwrt-builder.packages /
COPY ../scripts/buildo /usr/local/bin/
COPY ../scripts/llvm-fix /usr/local/bin/


# Run the setup scripts
RUN chmod +x setup-env.sh distrobox-shims.sh /usr/local/bin/buildo /usr/local/bin/llvm-fix && /setup-env.sh

# justfile, fish config and bass plugin
COPY ../shell/config.fish /etc/fish/config.fish
COPY ../shell/bass/ /etc/fish/functions/
RUN chmod 644 /etc/fish/functions/__bass.py /etc/fish/functions/bass.fish
RUN mkdir -p /etc/just
COPY ../scripts/justfile /etc/just/justfile
RUN echo "alias just='just --justfile /etc/just/justfile --working-directory .'" >> /etc/profile
# lax the password rules inside the container
RUN sed -i 's/obscure yescrypt/minlen=2 nullok/' /etc/pam.d/common-password
