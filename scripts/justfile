# OpenWrt Build Helper Justfile
# Version: 0.3
# Author: github.com/Ogglord

set shell := ["bash", "-c"]
set dotenv-load := true
set unstable

# Build settings
jobs := env_var_or_default("BUILD_JOBS", num_cpus())
make_flags := "V=s world"
remove_apps := "audit busybox kexec-tools lldpd policycoreutils"

# Show available recipes
@default:
    echo "OpenWrt Builder v0.3"
    echo "-------------------"
    echo "Commands:"
    echo "  just fullbuild  - Complete build with feeds update"
    echo "  just build      - Standard build"
    echo "  just debug      - Debug build (single thread)"
    echo "  just llvm-fix   - Configure LLVM toolchain"
    echo ""
    echo "Environment:"
    echo "  BUILD_JOBS      - Override number of build jobs (default: $(nproc))"
    echo "  LLVM_HOST_PATH  - Required for LLVM configuration"

# Directory checks - are we in the openwrt source directory?
dir_toolchain := if path_exists("toolchain") == "true" { "true" } else { "false" }
file_makefile := if path_exists("Makefile")  == "true" { "true" } else { "false" }
file_feeds := if path_exists("scripts/feeds")  == "true" { "true" } else { "false" }
dir_ok := if dir_toolchain == "true" { if file_makefile == "true" { if file_feeds == "true" { "true" } else { "false"} } else { "false" } } else { "false"}
openwrt_pwd_check :=  if dir_toolchain == "true" { "OK" } else { error("You must run just from the openwrt source root") }


# Update and install feeds
_update_feeds:
    ./scripts/feeds update -a
    ./scripts/feeds install -a
    ./scripts/feeds uninstall {{remove_apps}}
    ./scripts/feeds install -a

# Build recipes
fullbuild: llvm-fix
    just _update_feeds
    make download
    just _configure_llvm
    make defconfig
    make -j {{jobs}} {{make_flags}}


build: llvm-fix
    just _configure_llvm
    make defconfig
    make -j {{jobs}} {{make_flags}}


debug: llvm-fix
    just _configure_llvm
    make defconfig
    make -j1 {{make_flags}}


[script("/usr/local/bin/llvm-fix")]
llvm-fix:
