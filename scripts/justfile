# OpenWrt Build Helper Justfile
# Version: 0.2
# Author: github.com/Ogglord

set shell := ["bash", "-uc"]

# Default recipe to show help
default:
    @just --list

# Environment variables and constants
export LOG_DIR := "./build_logs"
export TIMESTAMP := `date +"%Y%m%d_%H%M%S"`

# Required apps for feeds
remove_apps := "audit busybox kexec-tools lldpd policycoreutils"
install_apps := "busybox kexec-tools lldpd policycoreutils"

# Create log directory and print header
_init:
    mkdir -p "${LOG_DIR}"
    echo "OpenWrt Build Helper Justfile version 0.2 - github.com/Ogglord"
    echo "-"

# Log a message with level and content
_log level message:
    #!/usr/bin/env bash
    log_file="${LOG_DIR}/${level}_${TIMESTAMP}.log"
    case "{{level}}" in
        "error")
            echo "[ERROR] {{message}}" >&2
            ;;
        "warning")
            echo "[WARNING] {{message}}" >&2
            ;;
        "info")
            echo "[INFO] {{message}}"
            ;;
        *)
            echo "{{message}}"
            ;;
    esac
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] {{level}}: {{message}}" >> "$log_file"

# Cleanup old log files
_cleanup:
    #!/usr/bin/env bash
    just _log info "Cleaning up old log files..."
    find "${LOG_DIR}" -type f -name "*_error_*.log" | sort | head -n -5 | xargs -r rm
    find "${LOG_DIR}" -type f -name "*_warning_*.log" | sort | head -n -5 | xargs -r rm
    find "${LOG_DIR}" -type f -name "*_info_*.log" | sort | head -n -5 | xargs -r rm

# Check if current directory is an OpenWrt source folder
_check_openwrt_source:
    #!/usr/bin/env bash
    required_dirs=("scripts" "package" "target" "toolchain")
    required_files=("Makefile" "scripts/feeds")
    missing_dirs=()
    missing_files=()
    
    for dir in "${required_dirs[@]}"; do
        [ ! -d "$dir" ] && missing_dirs+=("$dir")
    done
    
    for file in "${required_files[@]}"; do
        [ ! -f "$file" ] && missing_files+=("$file")
    done
    
    if [ ${#missing_dirs[@]} -gt 0 ] || [ ${#missing_files[@]} -gt 0 ]; then
        just _log error "Invalid OpenWrt source directory"
        [ ${#missing_dirs[@]} -gt 0 ] && just _log error "Missing directories: ${missing_dirs[*]}"
        [ ${#missing_files[@]} -gt 0 ] && just _log error "Missing files: ${missing_files[*]}"
        just _log error "Make sure you're running this from the OpenWrt root directory"
        exit 1
    fi
    
    just _log info "OpenWrt source directory validated successfully"

# Update and install feeds
_update_install_feeds:
    #!/usr/bin/env bash
    just _log info "Step 1. Updating and installing all feeds..."
    ./scripts/feeds update -a 2>&1 | tee "${LOG_DIR}/feeds.log"
    ./scripts/feeds install -a 2>&1 | tee -a "${LOG_DIR}/feeds.log"
    
    just _log info "Reinstalling apps that fail on the first attempt..."
    ./scripts/feeds uninstall ${remove_apps} 2>&1 | tee -a "${LOG_DIR}/feeds.log"
    ./scripts/feeds install -a 2>&1 | tee -a "${LOG_DIR}/feeds.log"
    
    just _log info "Step 1. COMPLETED. Logs at ${LOG_DIR}/feeds.log"

# Download required applications
_download_apps:
    #!/usr/bin/env bash
    just _log info "Step 2. Running 'make -j1 download'. Logging to ${LOG_DIR}/download.log"
    make -j1 download | tee "${LOG_DIR}/download.log"
    just _log info "Step 2. COMPLETED. Logs at ${LOG_DIR}/download.log"

# Check for broken symlinks in staging directory
_check_staging_symlinks:
    #!/usr/bin/env bash
    staging_dir="./staging_dir/host/bin"
    
    if [ ! -d "$staging_dir" ]; then
        just _log warning "Staging directory does not exist: $staging_dir"
        exit 0
    fi
    
    cd "$staging_dir"
    broken_links=$(find . -xtype l -print || true)
    
    if [ -n "$broken_links" ]; then
        just _log error "Broken symlinks detected:"
        echo "$broken_links" | while read -r link; do
            just _log error "Broken symlink: $link"
        done
        exit 1
    else
        just _log info "No broken symlinks found in staging directory"
    fi

# Configure LLVM toolchain settings
_configure_llvm_toolchain:
    #!/usr/bin/env bash
    if [ -z "${LLVM_HOST_PATH:-}" ]; then
        just _log error "LLVM_HOST_PATH is not set or is empty"
        exit 1
    fi
    
    config_file=".config"
    if [ ! -e "$config_file" ]; then
        just _log warning "Configuration file missing: $config_file"
        exit 0
    fi
    
    # Unset BPF toolchain build flag
    if grep -q "CONFIG_BPF_TOOLCHAIN_BUILD_LLVM=y" "$config_file"; then
        just _log info "Unsetting CONFIG_BPF_TOOLCHAIN_BUILD_LLVM"
        sed -i -e 's|CONFIG_BPF_TOOLCHAIN_BUILD_LLVM=y|# CONFIG_BPF_TOOLCHAIN_BUILD_LLVM is not set|' "$config_file"
    fi
    
    # Handle LLVM host path configuration
    if grep -q "CONFIG_BPF_TOOLCHAIN_HOST_PATH" "$config_file"; then
        just _log info "Updating existing LLVM host path"
        sed -i -e 's|CONFIG_BPF_TOOLCHAIN_HOST_PATH=.*|CONFIG_BPF_TOOLCHAIN_HOST_PATH="'"$LLVM_HOST_PATH"'"|' "$config_file"
    else
        just _log info "Adding LLVM host path configuration"
        echo 'CONFIG_BPF_TOOLCHAIN_HOST_PATH="'"$LLVM_HOST_PATH"'"' >> "$config_file"
        echo 'CONFIG_BPF_TOOLCHAIN_HOST=y' >> "$config_file"
        echo 'CONFIG_USE_LLVM_HOST=y' >> "$config_file"
    fi

# Run LLVM fix
_run_llvm_fix:
    #!/usr/bin/env bash
    just _log info "Applying automatic adjustments for OpenWrt environment..."
    just _check_staging_symlinks
    just _configure_llvm_toolchain
    just _log info "OpenWrt fixes applied successfully"

# Full build: update feeds, download apps, and build
fullbuild:
    just _init
    just _check_openwrt_source
    just _update_install_feeds
    just _download_apps
    just _run_llvm_fix
    just _log info "Running make defconfig..."
    make defconfig
    just _log info "Starting build process..."
    make -j $(($(nproc)+1)) V=s world 2>&1 | tee "${LOG_DIR}/build.log" | grep -i -E "^make.*(error|[12345]...Entering dir)"
    just _cleanup
    just _log info "Build process completed! Check logs in ${LOG_DIR} for full output."

# Normal build: build only
build:
    just _init
    just _check_openwrt_source
    just _run_llvm_fix
    just _log info "Running make defconfig..."
    make defconfig
    just _log info "Starting build process..."
    make -j $(($(nproc)+1)) V=s world 2>&1 | tee "${LOG_DIR}/build.log" | grep -i -E "^make.*(error|[12345]...Entering dir)"
    just _cleanup
    just _log info "Build process completed! Check logs in ${LOG_DIR} for full output."

# Debug build: single thread verbose build
debug:
    just _init
    just _check_openwrt_source
    just _run_llvm_fix
    just _log info "Running make defconfig..."
    make defconfig
    just _log info "Starting build process in debug mode..."
    make -j1 V=s world 2>&1 | tee "${LOG_DIR}/build_debug.log"
    just _cleanup
    just _log info "Build process completed! Check logs in ${LOG_DIR} for full output."

# LLVM fix: configure LLVM toolchain settings
llvm-fix:
    just _init
    just _check_openwrt_source
    just _run_llvm_fix
